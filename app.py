import streamlit as st
import pandas as pd
from ozon_core_cleaned_fixed import calculate_all
import matplotlib.pyplot as plt
from openai import OpenAI
import streamlit as st
import openai
import io

openai.api_key = st.secrets["OPENAI_API_KEY"]

st.set_page_config(page_title="Ozon Margin Analyzer", layout="wide")
st.title("üßæ Ozon Margin Analyzer")
#results = st.session_state.get("results")
st.subheader("üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–∏")


with st.sidebar:
    st.markdown("üîê **API-–∫–ª—é—á–∏ Ozon**")
    api_key = st.text_input("API –∫–ª—é—á Ozon", type="password")
    perf_key = st.text_input("API –∫–ª—é—á Performance API", type="password")
    client_id = st.text_input("Client ID (Seller ID)", type="default")
    perf_client_id = st.text_input("Performance Client ID")
    st.markdown("–ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Å—Å–∏–∏ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.")


st.markdown("### üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é")
upload_method = st.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:", ["–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel", "–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é"])

price = None

if upload_method == "–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel":
    uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ .xlsx —Ñ–∞–π–ª —Å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º", type="xlsx")
    if uploaded_file is not None:
        try:
            price = pd.read_excel(uploaded_file)
            st.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.")
            st.dataframe(price)
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel-—Ñ–∞–π–ª–∞: {e}")
else:
    st.info("‚ö†Ô∏è –†—É—á–Ω–æ–π –≤–≤–æ–¥ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Excel.")



if st.button("üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å (—ç—Ç–∞–ø 2)"):
    if not api_key or not perf_key or not client_id or price is None:
        st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å.")
    else:
        with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á—ë—Ç..."):
            try:
                results = calculate_all(api_key, perf_key, perf_client_id, price, client_id)
                st.session_state.results = results
              #  st.write("üîç –°–æ–¥–µ—Ä–∂–∏–º–æ–µ results:")
              #  for key in results:
              #      st.write("-", key)
                st.session_state.show_results = True
                st.success("–†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            except Exception as e:
                st.session_state.show_results = False
                st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")


if st.session_state.get("show_results") and "results" in st.session_state:
    st.markdown("### ‚¨áÔ∏è –°–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ Excel-–æ—Ç—á—ë—Ç—ã")
    st.download_button("üì• –û—Ç—á—ë—Ç –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É", data=st.session_state.results["buffer_account"].getvalue(), file_name="account_summary.xlsx")
    st.download_button("üì• –û—Ç—á—ë—Ç –ø–æ SKU (—é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∞)", data=st.session_state.results["buffer_sku"].getvalue(), file_name="sku_unit_economics.xlsx")

    for name, value in st.session_state.results.items():
        if name.startswith("buffer"):  # –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –±—É—Ñ–µ—Ä—ã
            continue

        st.subheader(name)

        if isinstance(value, plt.Figure):
            st.pyplot(value)
        elif isinstance(value, pd.DataFrame):
            st.dataframe(value, use_container_width=True)
        elif isinstance(value, dict):
            for k, v in value.items():
                st.markdown(f"**{k}**: {v}")
        else:
            st.write(value)



if st.button("–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ AI"):
    if "results" not in st.session_state or "buffer_insights" not in st.session_state.results:
        st.error("–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π –æ—Ç—á—ë—Ç—ã.")
    else:
        with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç—ã..."):
            try:
                # –ß–∏—Ç–∞–µ–º –æ–±–∞ Excel-—Ñ–∞–π–ª–∞ –∏–∑ –±—É—Ñ–µ—Ä–æ–≤
                df_account = pd.read_excel(st.session_state.results["buffer_account"], sheet_name=None)
                df_insights = pd.read_excel(st.session_state.results["buffer_insights"], sheet_name=None)

                # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å—ë –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
                full_report = ""
                for name, table in {**df_account, **df_insights}.items():
                    full_report += f"\n\n{name}:\n{table.to_string(index=False)}"

                # –°–∞–º –ø—Ä–æ–º—Ç
                prompt = ( f"""–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ Ozon. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø–∏—à–∏ –æ—á–µ–Ω—å —á—ë—Ç–∫–∏–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç –¥–ª—è —Å–µ–ª–ª–µ—Ä–∞. –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —Ç–æ—á–Ω–æ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏.
                –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–≤–æ–µ–≥–æ –æ—Ç—á—ë—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π:
                
                1. –û–±—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –ø–æ –º–∞—Ä–∂–µ:
                ‚Ä¢	–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞ –≤—á–µ—Ä–∞: (–∑–Ω–∞—á–µ–Ω–∏–µ)%.
                ‚Ä¢	–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞ –º–µ—Å—è—Ü: (–∑–Ω–∞—á–µ–Ω–∏–µ)%.
                –î–∏–Ω–∞–º–∏–∫–∞: —É–∫–∞–∂–∏ —è–≤–Ω–æ, –º–∞—Ä–∂–∞ —Ä–∞—Å—Ç—ë—Ç –∏–ª–∏ –ø–∞–¥–∞–µ—Ç (–µ—Å–ª–∏ –º–∞—Ä–∂–∞ –∑–∞ –≤—á–µ—Ä–∞ –≤—ã—à–µ –º–µ—Å—è—á–Ω–æ–π ‚Äî –∑–Ω–∞—á–∏—Ç —Ä–∞—Å—Ç—ë—Ç, –µ—Å–ª–∏ –Ω–∏–∂–µ ‚Äî –∑–Ω–∞—á–∏—Ç –ø–∞–¥–∞–µ—Ç). –†–∞—Å—Ç–µ—Ç –ø—Ä–∏–±—ã–ª—å –∏–ª–∏ –ø–∞–¥–∞–µ—Ç.
                
                2. –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–æ–π –º–∞—Ä–∂–æ–π (–º–µ–Ω–µ–µ 20%):
                –û—Ç–¥–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ç–∞–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ—á–∫–∏. 
                
                ‚Ä¢	–ù–∞–∑–≤–∞–Ω–∏–µ SKU ‚Äî –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞ –≤—á–µ—Ä–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ)%, –º–∞—Ä–∂–∏–Ω–≤–ª—å–Ω–æ—Å—Ç—å –∑–∞ –º–µ—Å—è—Ü (–∑–Ω–∞—á–µ–Ω–∏–µ)%
                
                –í –∫–æ–Ω—Ü–µ –Ω–∞–ø–∏—à–∏: ¬´–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–∏ —Ç–æ–≤–∞—Ä—ã, –º–∞—Ä–∂–∞ –ø–æ –Ω–∏–º –Ω–∏–∂–µ 20%.¬ª —Ü–µ–Ω—ã –Ω–∞ —ç—Ç–∏ —Ç–æ–≤–∞—Ä—ã —Å—Ç–æ–∏—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å. –ß—É—Ç–æ–∫ –ø–æ—Ä–∞—Å—Å—É–∂–¥–∞–π –∫–∞–∫ –ø—Ä–æ—Ñ–∏.
                
                3. –¢–æ–≤–∞—Ä—ã —Å –≤—ã—Å–æ–∫–∏–º —Ä–∞—Å—Ö–æ–¥–æ–º –Ω–∞ —Ä–µ–∫–ª–∞–º—É (–≤—ã—Å–æ–∫–∞—è –î–†–†)
                
                –û—Ç–¥–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ç–∞–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤, –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ—á–∫–∏. 
                
                ‚Ä¢	–ù–∞–∑–≤–∞–Ω–∏–µ SKU ‚Äî –î–†–† –∑–∞ –≤—á–µ—Ä–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ)%, –∏ –∑–∞ –º–µ—Å—è—Ü (–∑–Ω–∞—á–µ–Ω–∏–µ)%.
                –í –∫–æ–Ω—Ü–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏ –æ–¥–Ω–∏–º –ø–æ–Ω—è—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞ –ø–æ—Å–ª–µ –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ä–∞—Å—Å—É–∂–¥–∞–π –ø—Ä–æ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: ¬´–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π —ç—Ç–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤, —Ä–µ–∫–ª–∞–º–∞ —Å—ä–µ–¥–∞–µ—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –ø—Ä–∏–±—ã–ª–∏.¬ª –ü–æ—Ä–∞—Å—Å—É–∂–¥–∞–π —á—É—Ç—å —á—É—Ç—å –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞—é—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã.
                
                4. –°–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
                
                –û—Ç–¥–µ–ª—å–Ω–æ —Ç–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –≤—á–µ—Ä–∞ –∏ —Ç–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –º–µ—Å—è—Ü. 
                
                ‚Ä¢	–ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî –ø—Ä–∏–±—ã–ª—å (–∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä—É–±–ª—è—Ö).
                –ó–∞–∫–æ–Ω—á–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º: ¬´–≠—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é –ø—Ä–∏–±—ã–ª—å.¬ª

                –í –∫–æ–Ω—Ü–µ –Ω–µ–º–Ω–æ–≥–æ –æ—Ü–µ–Ω–∏ —á—Ç–æ –≤—Å–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤ —Ü–µ–ª–æ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É.
                
                
                –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç—á—ë—Ç–∞:
                
                –ü–∏—à–∏ –ø–æ–Ω—è—Ç–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —ç–º–æ–¥–∑–∏. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—è–π —Å–ª–æ–≤–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏ –Ω–æ–≤—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
                –ß—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –∏ —Å–ø–∏—Å–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è.
                –ù–∏–∫–∞–∫–∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–∞–±–ª–∏—Ü, —Ç–æ–ª—å–∫–æ –ø–æ–Ω—è—Ç–Ω—ã–µ –∏ –ø—Ä–æ—Å—Ç—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Å–µ–ª–ª–µ—Ä–∞.
                –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –ª–æ–≥–∏–∫—É –¥–∏–Ω–∞–º–∏–∫–∏ –º–∞—Ä–∂–∏ –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º.
                –ù—É–∂–Ω–æ —á—Ç–æ–±—ã —Ç–≤–æ–π –æ—Ç—á–µ—Ç –±—ã–ª –ø–æ–Ω—è—Ç–Ω—ã–º. –ü–æ—ç—Ç–æ–º—É –∫–∞–∂–¥—ã–π –¢–æ–≤–∞—Ä –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ—á–∫–µ, –∫—Ä–∞—Å–∏–≤–æ, –ø–æ–Ω—è—Ç–Ω–æ. –î–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞. –í –∫–æ–Ω—Ü–µ
                —á—É—Ç—å —á—É—Ç—å –ø–æ—Ä–∞—Å—Å—É–∂–¥–∞–π –æ —Ç–æ–º, —á—Ç–æ –Ω—É–∂–Ω–æ –≤—Å–µ–≥–¥–∞ –¥–µ—Ä–∂–∞—Ç—å —Ä—É–∫—É –Ω–∞ –ø—É–ª—å—Å–µ –∏ —á—Ç–æ –¥–∞–∂–µ —É –æ–ø—ã—Ç–Ω—ã—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –±—ã–≤–∞—é—Ç –Ω–µ–¥–æ—á–µ—Ç—ã –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–æ —Å—Ä–∞–∑—É –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.
                     {full_report}"""
                )

                client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
                response = client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.4,
                    max_tokens=2000
                )

                st.subheader("üìã GPT-–∞–Ω–∞–ª–∏–∑ –æ—Ç—á—ë—Ç–æ–≤")
                st.write(response.choices[0].message.content)

            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: {e}")
